name: BitBucket Server Migration Tool Windows
on:
  workflow_dispatch:
  
jobs: 
  Get-Repositories-to-Migrate:
    # Specifies the operating system environment on which the workflow will run.
    # In this case, it is set to "ubuntu-latest", which indicates the latest version of Ubuntu.
    runs-on: ubuntu-latest
 
    # CONFIGURE PROJECT MATRIX
    outputs:
      # SET PROJECTS OUTPUT FROM SET-MATRIX STEP
      PROJECTS: ${{ steps.set-matrix.outputs.PROJECTS }}
    
    steps:
      - name: Checkout to repository
        uses: actions/checkout@v3
     
      - name: Set matrix data
        id: set-matrix
        # STORE PROJECTS.JSON INTO PROJECTS VARIABLE
        run: echo "PROJECTS=$(jq -c . < ./projects.json)" >> $GITHUB_OUTPUT
        
  Migration:
    runs-on: [ 'self-hosted' , 'Linux' , 'X64' ]
    needs: Get-Repositories-to-Migrate
    strategy:
      max-parallel: 1
      # SET MATRIX WITH PROJECTS TO MIGRATE
      matrix: ${{ fromJson(needs.Get-Repositories-to-Migrate.outputs.PROJECTS) }}
      
    steps:
      - name: Checkout to repository
        uses: actions/checkout@v3
              
      - name: Migration
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          BBS_USERNAME: ${{ secrets.BBS_USERNAME }}
          BBS_PASSWORD: ${{ secrets.BBS_PASSWORD }}
          BBS_TOKEN: ${{ secrets.BBS_TOKEN }}
          
        run: |
          ls
          echo "${{ matrix.project }}"

      - name: Pull request
        run: |
          curl -X GET \
          http://localhost:7990/rest/api/latest/projects/${{ matrix.project }}/repos/repo-test/pull-requests \
          -H 'Accept: application/json' \
          -H 'Authorization: Bearer ${{ secrets.BBS_TOKEN }}' \
          -o bbs_pullrequest.json
          
      - name: Clone BitBucket Repository {{ item.bbs_repository_name }}
        run: git clone http://${{ secrets.BBS_USERNAME }}:${{ secrets.BBS_PASSWORD }}@localhost:7990/scm/proj/repo-test.git

          
